<project name="distro.build" default="build" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">

	<loadproperties srcfile="build.properties"/>
	<import file="${cfdistro.build.file}"/>

	<target name="mxunit-ant.getversion">
		<loadfile srcFile="${src.dir}/mxunit-ant/org/mxunit/ant/MXUnitAntTask.java" property="mxunit-ant.version"/>
		<antcontrib:propertyregex override="yes" property="mxunit-ant.version" input="${mxunit-ant.version}" 
			regexp=".*?version\s?=\s?&quot;([^&quot;]+).*?" select="\1" />
		<echo message="mxunit-ant version: ${mxunit-ant.version}" />
	</target>

	<property name="site.suffix" value=""/>
	<property name="merge.site" value="true"/>
	<property name="plugin.p2.dir" value="${dist.dir}/update${site.suffix}"/>
	<property name="plugin.p2.release.dir" value="http://mxunit.org:80/update${site.suffix}"/>
	<property name="remote.cfeclipse.sites.dir" value="from.cfeclipse.properties"/>
	<property name="remote.p2.dir" value="${remote.sites.dir}/mxunit-update${site.suffix}"/>
	<property name="branchTagPath" value="master"/>
	
	<target name="clean.all">
		<delete dir="${dist.dir}"/>
		<delete dir="${basedir}/workspace"/>
		<delete dir="${basedir}/target-platform"/>
	</target>

	<target name="build.eclipse">
		<abspath property="src.dir" path="${src.dir}" />
		<abspath property="dist.dir" path="${dist.dir}" />
		<abspath property="product.zip.dir" path="${dist.dir}/product" />
		<mkdir dir="${dist.dir}"/>
		<property name="script.dir" location="${src.dir}/org.mxunit.eclipseplugin.releng"/>
		<echo message="branchTagPath : ${branchTagPath}"/>
		<replaceregexp file="${script.dir}/build.cquery" byline="true"
			match="branchTagPath.?=.?&quot;.*?&quot;" replace="branchTagPath=&quot;${branchTagPath}&quot;"
		/>
		<bucky.headless script="${script.dir}/promote.bmscript">
			<sysproperty key="branchTagPath" value="${branchTagPath}" />
			<sysproperty key="script.dir" value="${script.dir}" />
			<sysproperty key="src.dir" value="${src.dir}" />
			<sysproperty key="dist.dir" value="${dist.dir}" />
			<sysproperty key="product.zip.dir" value="${product.zip.dir}" />
			<sysproperty key="plugin.p2.dir" value="${plugin.p2.dir}" />
		</bucky.headless>
		<bucky.headless script="${src.dir}/org.mxunit.eclipseplugin.releng/merge.bmscript">
			<sysproperty key="plugin.p2.source" value="${plugin.p2.release.dir}" />
			<sysproperty key="plugin.p2.dest" value="${plugin.p2.dir}" />
		</bucky.headless>
	</target>	

	<target name="merge.site">
		<abspath property="src.dir" path="${src.dir}" />
		<abspath property="dist.dir" path="${dist.dir}" />
		<bucky.headless script="${src.dir}/org.mxunit.eclipseplugin.releng/merge.bmscript">
			<sysproperty key="plugin.p2.source" value="${plugin.p2.release.dir}" />
			<sysproperty key="plugin.p2.dest" value="${plugin.p2.dir}" />
		</bucky.headless>
	</target>	

	<target name="build.eclipse.and.scp" depends="build.eclipse">
		<antcontrib:var name="remote" value="cfeclipse"/>
		<cfdistro.setremote />
		<loadproperties srcfile="${src.dir}/org.mxunit.eclipseplugin.releng/build.properties"/>
		<echo message="scp update site"/>
		<deploy-scp toDir="${remote.user}@${remote.host}:${remote.p2.dir}" fromdir="${plugin.p2.dir}">
			<scpfiles>
				<fileset dir="${plugin.p2.dir}">
					<include name="**/*"/>
				</fileset>
			</scpfiles>
		</deploy-scp>
	</target>	
	
	<target name="build" depends="cfdistro.build, src.to.mappings.xml, set.mappings">
		<loadproperties prefix="mxb" srcfile="${src.dir}/mxunit/buildprops/version.properties"/>
	   	<antcontrib:var name="mxunit.version" value="${mxb.build.major}.${mxb.build.minor}.${mxb.build.buildnum}" />
	   	<echo message="mxunit version: ${mxunit.version}" />
		<zip destfile="${dist.dir}/mxunit.zip" basedir="${src.dir}/mxunit" includes="framework/** runner/**" />
		<zip destfile="${dist.dir}/mxunit-all.zip" basedir="${src.dir}/mxunit" includes="**" />
		<antcontrib:var name="runwar.port" value="0" />
		<antcontrib:var name="runwar.stop.socket" value="0" />
		<server-run>
			<java
			        classname="org.apache.tools.ant.launch.Launcher"
			        fork="true"
			        failonerror="true"
			        dir="${src.dir}/mxunit-ant/"
			        timeout="4000000"
			        taskname="startAnt"
			>
			    <classpath>
			        <pathelement location="${ant.home}/lib/ant-launcher.jar"/>
					<fileset dir="${cfdistro.lib.dir}">
						<include name="**/*.jar" />
					</fileset>
			    </classpath>
			    <arg value="-buildfile"/>
			    <arg file="${src.dir}/mxunit-ant/build.xml"/>
			    <arg value="-Dserver.port.http=${server.port.http}"/>
			    <arg value="-Dbasedir=${src.dir}/mxunit-ant/"/>
			    <arg value="-Dbuild.compiler=org.eclipse.jdt.core.JDTCompilerAdapter"/>
			    <arg value="runTests"/>
			</java>
		</server-run>
	</target>

	<target name="build.mvn.release" depends="project.update, build.mxunit.tests.run, mxunit-ant.getversion">
		<!-- 
	   	<property name="release.repo.user" value="admin" />
	   	<property name="release.repo.password" value="admin123" />
	   	<property name="release.repo.url" value="admin123" />
	    <mvn-repo id="release.repo" url="http://127.0.0.1:8081/nexus/content/repositories/releases">
	    	<authentication>
	    		<authentication username="${release.repo.user}" password="${release.repo.password}"/>
    		</authentication>
	    </mvn-repo>

		<property name="target.repo.id" value="release.repo" />
		<property name="target.repo.id" value="loganberry.repo" />
		 -->
		<property name="target.repo.id" value="cfdistro.repo.local" />

		<mvn-put artifact="${dist.dir}/mxunit.zip" packaging="zip" repoId="${target.repo.id}"
		 groupId="org.mxunit" artifactId="core" version="${mxunit.version}"/>

		<mvn-put artifact="${dist.dir}/mxunit-all.zip" packaging="zip" repoId="${target.repo.id}"
		 groupId="org.mxunit" artifactId="mxunit" version="${mxunit.version}" />
		
		<!--  create an extension -->
	    <delete dir="${basedir}/extensionbase/" />
	    <mkdir dir="${basedir}/extensionbase/" />
		<copy todir="${basedir}/extensionbase/applications/mxunit">
			<fileset dir="${src.dir}/mxunit" />
		</copy>
		<property name="extension.label" value="MXUnit ${mxunit.version}" />
		<antcontrib:runtarget target="extension.build" />

		<!-- add the extension as well -->
		<mvn-put artifact="${extension.dist}/${extension.archive}" packaging="zip" repoId="${target.repo.id}"
		 groupId="cfml.extension" artifactId="mxunit" version="${extension.version}" />

	    <delete dir="${basedir}/extensionbase/" />

		<mvn-put artifact="${src.dir}/mxunit-ant/dist/mxunit-ant.jar" packaging="jar" repoId="${target.repo.id}"
		 groupId="org.mxunit" artifactId="mxunit-ant" version="${mxunit-ant.version}"/>

	</target>	
	
</project>