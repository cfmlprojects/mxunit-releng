<project name="distro.build" default="build" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">

	<loadproperties srcfile="build.properties"/>
	<import file="${cfdistro.build.file}"/>

	<target name="mxunit-ant.getversion">
		<loadfile srcFile="${src.dir}/mxunit-ant/org/mxunit/ant/MXUnitAntTask.java" property="mxunit-ant.version"/>
		<antcontrib:propertyregex override="yes" property="mxunit-ant.version" input="${mxunit-ant.version}" 
			regexp=".*?version\s?=\s?&quot;([^&quot;]+).*?" select="\1" />
		<echo message="mxunit-ant version: ${mxunit-ant.version}" />
	</target>

	<target name="build" depends="cfdistro.build, src.to.mappings.xml, set.mappings">
		<loadproperties prefix="mxb" srcfile="${src.dir}/mxunit/buildprops/version.properties"/>
	   	<antcontrib:var name="mxunit.version" value="${mxb.build.major}.${mxb.build.minor}.${mxb.build.buildnum}" />
	   	<echo message="mxunit version: ${mxunit.version}" />
		<zip destfile="${dist.dir}/mxunit.zip" basedir="${src.dir}" includes="mxunit/framework/** mxunit/runner/**" />
		<zip destfile="${dist.dir}/mxunit-all.zip" basedir="${src.dir}/" includes="mxunit/**" />
		<antcontrib:var name="runwar.port" value="0" />
		<antcontrib:var name="runwar.stop.socket" value="0" />
		<server-run>
			<ant inheritAll="false" antfile="build.xml" dir="${src.dir}/mxunit-ant/">
			  <property name="server.port.http" value="${server.port.http}"/>
			</ant>
		</server-run>
	</target>

	<target name="build.mvn.release" depends="project.update, build.mxunit.tests.run, mxunit-ant.getversion">
		<!-- 
	   	<property name="release.repo.user" value="admin" />
	   	<property name="release.repo.password" value="admin123" />
	   	<property name="release.repo.url" value="admin123" />
	    <mvn-repo id="release.repo" url="http://127.0.0.1:8081/nexus/content/repositories/releases">
	    	<authentication>
	    		<authentication username="${release.repo.user}" password="${release.repo.password}"/>
    		</authentication>
	    </mvn-repo>

		<property name="target.repo.id" value="release.repo" />
		<property name="target.repo.id" value="loganberry.repo" />
		 -->
		<property name="target.repo.id" value="cfdistro.repo.local" />

		<mvn-put artifact="${dist.dir}/mxunit.zip" packaging="zip" repoId="${target.repo.id}"
		 groupId="org.mxunit" artifactId="core" version="${mxunit.version}"/>

		<mvn-put artifact="${dist.dir}/mxunit-all.zip" packaging="zip" repoId="${target.repo.id}"
		 groupId="org.mxunit" artifactId="mxunit" version="${mxunit.version}" />
		
		<!--  create an extension -->
	    <delete dir="${basedir}/extensionbase/" />
	    <mkdir dir="${basedir}/extensionbase/" />
		<copy todir="${basedir}/extensionbase/applications/mxunit">
			<fileset dir="${src.dir}/mxunit" />
		</copy>
		<property name="extension.label" value="MXUnit ${mxunit.version}" />
		<antcontrib:runtarget target="extension.build" />

		<!-- add the extension as well -->
		<mvn-put artifact="${extension.dist}/${extension.archive}" packaging="zip" repoId="${target.repo.id}"
		 groupId="cfml.extension" artifactId="mxunit" version="${extension.version}" />

	    <delete dir="${basedir}/extensionbase/" />

		<mvn-put artifact="${src.dir}/mxunit-ant/dist/mxunit-ant.jar" packaging="jar" repoId="${target.repo.id}"
		 groupId="org.mxunit" artifactId="mxunit-ant" version="${mxunit-ant.version}"/>

	</target>	
	
</project>